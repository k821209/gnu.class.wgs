<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ìŠµ 5: ê²°ê³¼ ë¶„ì„ ë° ì‹œê°í™” - VCF í•„í„°ë§ê³¼ ìƒë¬¼í•™ì  í•´ì„</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body { font-family: 'Malgun Gothic', Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
        .slide { width: 100%; height: 100vh; display: block; padding: 40px; box-sizing: border-box; background: white; }
        .slide-title { font-size: 36px; font-weight: bold; color: #2c3e50; margin-bottom: 30px; border-bottom: 3px solid #e67e22; padding-bottom: 10px; }
        .slide-content { font-size: 18px; line-height: 1.6; color: #34495e; }
        .slide-content h2 { color: #e67e22; font-size: 24px; margin-top: 30px; }
        .slide-content h3 { color: #e74c3c; font-size: 20px; margin-top: 20px; }
        .slide-content ul { margin: 15px 0; padding-left: 30px; }
        .slide-content li { margin: 8px 0; }
        .highlight { background: #fff3cd; padding: 3px 8px; border-radius: 3px; }
        .code-block { background: #1e1e1e; color: #f8f8f2; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; margin: 15px 0; font-size: 14px; white-space: pre-wrap; border: 1px solid #444; position: relative; }
        .code-block-container { position: relative; }
        .copy-button { position: absolute; top: 10px; right: 10px; background: #444; color: #f8f8f2; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px; opacity: 0.7; transition: opacity 0.2s; }
        .copy-button:hover { opacity: 1; background: #555; }
        .copy-button.copied { background: #27ae60; color: white; }
        .copy-button.copied:after { content: " âœ“"; }
        
        /* Syntax highlighting color classes */
        .comment { color: #75715e; } /* Comments */
        .keyword { color: #f92672; } /* Keywords */
        .function { color: #a6e22e; } /* Function names */
        .string { color: #e6db74; } /* Strings */
        .number { color: #ae81ff; } /* Numbers */
        .param { color: #fd971f; } /* Parameters */
        .variable { color: #f8f8f2; } /* Variables */
        .builtin { color: #a6e22e; } /* Built-in functions */
        .operator { color: #f92672; } /* Operators */
        .shebang { color: #75715e; } /* Shebang */
        .navigation { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        .nav-btn { background: #e67e22; color: white; border: none; padding: 10px 20px; margin: 0 5px; border-radius: 5px; cursor: pointer; }
        .nav-btn:hover { background: #d35400; }
        .fullscreen-btn { background: #e74c3c; color: white; border: none; padding: 10px 15px; margin: 0 5px; border-radius: 5px; cursor: pointer; }
        .fullscreen-btn:hover { background: #c0392b; }
        .jump-btn { background: #3498db; color: white; border: none; padding: 10px 15px; margin: 0 5px; border-radius: 5px; cursor: pointer; }
        .jump-btn:hover { background: #2980b9; }
        .slide-number { position: fixed; bottom: 20px; left: 20px; color: #7f8c8d; font-size: 14px; }
        .comparison-table { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .comparison-item { background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #e67e22; }
        .comparison-item h4 { margin: 0 0 10px 0; color: #2c3e50; }
        .setup-steps { background: #e8f4fd; border-left: 4px solid #3498db; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .practical-box { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .exercise-box { background: #fff3cd; border-left: 4px solid #ffc107; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .result-box { background: #d4edda; border-left: 4px solid #28a745; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .warning-box { background: #f8d7da; border-left: 4px solid #dc3545; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .step-box { background: #ffffff; border: 2px solid #e67e22; border-radius: 8px; padding: 15px; margin: 10px 0; position: relative; }
        .step-box::before { content: "â†’"; position: absolute; right: -15px; top: 50%; transform: translateY(-50%); font-size: 24px; color: #e67e22; }
        .step-box:last-child::before { display: none; }
        .terminal-output { background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; margin: 15px 0; font-size: 13px; white-space: pre-wrap; }
        .filter-criteria { background: #e8f5e8; border-left: 4px solid #28a745; padding: 15px; margin: 15px 0; border-radius: 8px; }
        .visualization-box { background: #f3e5f5; border-left: 4px solid #9b59b6; padding: 15px; margin: 15px 0; border-radius: 8px; }
        .performance-tip { background: #f0f8ff; border-left: 4px solid #007bff; padding: 15px; margin: 15px 0; border-radius: 8px; }
        .biological-insight { background: #fff8e1; border-left: 4px solid #ff9800; padding: 15px; margin: 15px 0; border-radius: 8px; }
        .summary-box { background: #f5f5f5; border: 2px solid #95a5a6; border-radius: 8px; padding: 20px; margin: 20px 0; }
    </style>
</head>
<body>

<div class="slide">
    <div class="slide-title">ğŸ“Š ì‹¤ìŠµ 5: ê²°ê³¼ ë¶„ì„ ë° ì‹œê°í™”</div>
    <div class="slide-content">
        <h2>ğŸ¯ ì‹¤ìŠµ ëª©í‘œ</h2>
        <p>ë³€ì´ í˜¸ì¶œ ê²°ê³¼ë¥¼ í•„í„°ë§í•˜ê³  ì‹œê°í™”í•˜ì—¬ ìƒë¬¼í•™ì ìœ¼ë¡œ ì˜ë¯¸ ìˆëŠ” ë³€ì´ë¥¼ ì‹ë³„í•˜ê³  í•´ì„í•˜ëŠ” ì¢…í•©ì ì¸ ë¶„ì„ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.</p>

        <div class="comparison-table">
            <div class="comparison-item">
                <h4><i class="fas fa-bullseye"></i> í•™ìŠµ ëª©í‘œ</h4>
                <ul>
                    <li>VCF í•„í„°ë§ ê¸°ì¤€ ì„¤ì •</li>
                    <li>ë³€ì´ í’ˆì§ˆ í‰ê°€ ë° ì„ ë³„</li>
                    <li>ë³€ì´ ì‹œê°í™” ë° ë¶„í¬ ë¶„ì„</li>
                    <li>ê¸°ëŠ¥ì  ì£¼ì„ í•´ì„</li>
                    <li>ìƒë¬¼í•™ì  ì˜ë¯¸ ë„ì¶œ</li>
                </ul>
            </div>
            
            <div class="comparison-item" style="border-left-color: #e74c3c;">
                <h4><i class="fas fa-tools"></i> ì‚¬ìš© ë„êµ¬</h4>
                <ul>
                    <li><strong>bcftools:</strong> VCF í•„í„°ë§ ë° í†µê³„</li>
                    <li><strong>VCFtools:</strong> ë³€ì´ ë¶„ì„ ë° í’ˆì§ˆ ê´€ë¦¬</li>
                    <li><strong>Python:</strong> ì‹œê°í™” ë° í†µê³„ ë¶„ì„</li>
                    <li><strong>IGV:</strong> ê²Œë†ˆ ë¸Œë¼ìš°ì € ì‹œê°í™”</li>
                </ul>
            </div>
        </div>

        <h2>ğŸ“‹ ì‹¤ìŠµ ì›Œí¬í”Œë¡œìš°</h2>
        <div class="practical-box">
            <div class="step-box">
                <h4><i class="fas fa-filter"></i> 1ë‹¨ê³„: VCF í•„í„°ë§</h4>
                <p>í’ˆì§ˆ ê¸°ì¤€ì— ë”°ë¥¸ ë³€ì´ í•„í„°ë§</p>
            </div>

            <div class="step-box">
                <h4><i class="fas fa-chart-line"></i> 2ë‹¨ê³„: ë³€ì´ ë¶„í¬ ë¶„ì„</h4>
                <p>ì—¼ìƒ‰ì²´ë³„, ìœ í˜•ë³„ ë³€ì´ ë¶„í¬ ì‹œê°í™”</p>
            </div>

            <div class="step-box">
                <h4><i class="fas fa-dna"></i> 3ë‹¨ê³„: ê¸°ëŠ¥ì  ë³€ì´ ë¶„ì„</h4>
                <p>ìœ ì „ì ì˜ì—­ë³„ ë³€ì´ ì˜í–¥ í‰ê°€</p>
            </div>

            <div class="step-box">
                <h4><i class="fas fa-search"></i> 4ë‹¨ê³„: ì£¼ìš” ë³€ì´ ì‹ë³„</h4>
                <p>ìƒë¬¼í•™ì ìœ¼ë¡œ ì¤‘ìš”í•œ ë³€ì´ ì„ ë³„</p>
            </div>

            <div class="step-box">
                <h4><i class="fas fa-file-alt"></i> 5ë‹¨ê³„: ê²°ê³¼ ìš”ì•½</h4>
                <p>ìµœì¢… ë³´ê³ ì„œ ì‘ì„± ë° í•´ì„</p>
            </div>
        </div>

        <h2>ğŸ” 1ë‹¨ê³„: VCF í•„í„°ë§</h2>
        <div class="practical-box">
            <h3><i class="fas fa-sliders-h"></i> í’ˆì§ˆ ê¸°ë°˜ í•„í„°ë§</h3>
            <p>ë‚®ì€ í’ˆì§ˆì˜ ë³€ì´ë¥¼ ì œê±°í•˜ì—¬ ì‹ ë¢°ì„± ìˆëŠ” ë³€ì´ë§Œ ì„ ë³„í•©ë‹ˆë‹¤.</p>
            
            <div class="code-block-container">
                <div class="code-block bash">
# ì‘ì—… ë””ë ‰í† ë¦¬ ì´ë™
cd /home/ubuntu/edu/soybean_data/variant_calling

# ê¸°ë³¸ í’ˆì§ˆ í•„í„°ë§ (GATK ê²°ê³¼)
bcftools filter \
    -i 'QUAL>=30 && DP>=10 && DP<=100' \
    -Oz -o soybean_gatk_filtered.vcf.gz \
    soybean_gatk.vcf.gz

# ì¸ë±ìŠ¤ ìƒì„±
bcftools index soybean_gatk_filtered.vcf.gz

# bcftools ê²°ê³¼ í•„í„°ë§
bcftools filter \
    -i 'QUAL>=20 && DP>=8 && DP<=80' \
    -Oz -o soybean_bcftools_filtered.vcf.gz \
    soybean_bcftools.vcf.gz

bcftools index soybean_bcftools_filtered.vcf.gz

# í•„í„°ë§ ì „í›„ ë¹„êµ
echo "=== í•„í„°ë§ ì „í›„ ë³€ì´ ìˆ˜ ë¹„êµ ==="
echo "GATK ì›ë³¸:"
bcftools stats soybean_gatk.vcf.gz | grep "^SN" | head -5

echo "GATK í•„í„°ë§ í›„:"
bcftools stats soybean_gatk_filtered.vcf.gz | grep "^SN" | head -5
</div>
            </div>
        </div>

        <div class="filter-criteria">
            <h4><i class="fas fa-check-square"></i> ê¶Œì¥ í•„í„°ë§ ê¸°ì¤€</h4>
            <div class="comparison-table">
                <div class="comparison-item" style="border-left-color: #28a745;">
                    <h4>SNP í•„í„°ë§</h4>
                    <ul>
                        <li><strong>QUAL:</strong> â‰¥ 30 (99.9% ì‹ ë¢°ë„)</li>
                        <li><strong>DP:</strong> 10-100 (ì ì ˆí•œ ê¹Šì´)</li>
                        <li><strong>QD:</strong> â‰¥ 2.0 (ê¹Šì´ë‹¹ í’ˆì§ˆ)</li>
                        <li><strong>FS:</strong> â‰¤ 60.0 (ìŠ¤íŠ¸ëœë“œ í¸í–¥)</li>
                        <li><strong>MQ:</strong> â‰¥ 40.0 (ë§¤í•‘ í’ˆì§ˆ)</li>
                    </ul>
                </div>
                
                <div class="comparison-item" style="border-left-color: #f39c12;">
                    <h4>INDEL í•„í„°ë§</h4>
                    <ul>
                        <li><strong>QUAL:</strong> â‰¥ 20 (99% ì‹ ë¢°ë„)</li>
                        <li><strong>DP:</strong> 8-80 (INDELì€ ë” ê´€ëŒ€)</li>
                        <li><strong>QD:</strong> â‰¥ 1.0 (INDEL íŠ¹ì„± ê³ ë ¤)</li>
                        <li><strong>FS:</strong> â‰¤ 200.0 (INDEL í—ˆìš©ì¹˜)</li>
                        <li><strong>ReadPosRankSum:</strong> â‰¥ -8.0</li>
                    </ul>
                </div>
            </div>
        </div>

        <h2>ğŸ“ˆ 2ë‹¨ê³„: ë³€ì´ ë¶„í¬ ë¶„ì„</h2>
        <div class="practical-box">
            <h3><i class="fas fa-chart-bar"></i> Pythonì„ ì´ìš©í•œ ì¢…í•© ë¶„ì„</h3>
            
            <div class="code-block-container">
                <div class="code-block python">
# !pip install koreanize-matplotlib í„°ë¯¸ë„ì— ì…ë ¥í•˜ì—¬ ì„¤ì¹˜
# ì„¤ì¹˜ í›„ importë¡œ ë¶ˆëŸ¬ì˜¤ê¸°

import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import numpy as np
import subprocess
from collections import Counter
import gzip
import koreanize_matplotlib

def comprehensive_variant_analysis(vcf_file, title="Variant Analysis"):
    """í¬ê´„ì ì¸ ë³€ì´ ë¶„ì„ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤."""
    
    print(f"ğŸ”¬ {title}")
    print("=" * 60)
    
    # VCF íŒŒì‹±
    variants = []
    
    if vcf_file.endswith('.gz'):
        file_opener = gzip.open
        mode = 'rt'
    else:
        file_opener = open
        mode = 'r'
    
    with file_opener(vcf_file, mode) as f:
        for line in f:
            if line.startswith('#'):
                continue
                
            fields = line.strip().split('\t')
            if len(fields) < 10:
                continue
                
            chrom = fields[0]
            pos = int(fields[1])
            ref = fields[3]
            alt = fields[4]
            qual = float(fields[5]) if fields[5] != '.' else 0
            info = fields[7]
            format_field = fields[8]
            sample = fields[9]
            
            # ë³€ì´ ìœ í˜• ê²°ì •
            if len(ref) == 1 and len(alt) == 1:
                variant_type = 'SNP'
                transition = classify_transition(ref, alt)
            elif len(ref) > len(alt):
                variant_type = 'Deletion'
                transition = 'INDEL'
            elif len(ref) < len(alt):
                variant_type = 'Insertion'
                transition = 'INDEL'
            else:
                variant_type = 'Complex'
                transition = 'Complex'
            
            # ê¹Šì´ ë° ìœ ì „ìí˜• ì •ë³´ ì¶”ì¶œ
            dp = extract_dp_from_info(info)
            gt = extract_genotype(sample)
            
            variants.append({
                'chrom': chrom,
                'pos': pos,
                'ref': ref,
                'alt': alt,
                'qual': qual,
                'type': variant_type,
                'transition': transition,
                'depth': dp,
                'genotype': gt
            })
    
    df = pd.DataFrame(variants)
    return df

def classify_transition(ref, alt):
    """SNPì˜ transition/transversion ë¶„ë¥˜"""
    transitions = [('A', 'G'), ('G', 'A'), ('C', 'T'), ('T', 'C')]
    if (ref, alt) in transitions:
        return 'Transition'
    else:
        return 'Transversion'

def extract_dp_from_info(info):
    """INFO í•„ë“œì—ì„œ DP ê°’ ì¶”ì¶œ"""
    for item in info.split(';'):
        if item.startswith('DP='):
            return int(item.split('=')[1])
    return 0

def extract_genotype(sample):
    """ìƒ˜í”Œ í•„ë“œì—ì„œ ìœ ì „ìí˜• ì¶”ì¶œ"""
    gt = sample.split(':')[0]
    if gt in ['0/0']:
        return 'Homozygous Reference'
    elif gt in ['0/1', '1/0']:
        return 'Heterozygous'
    elif gt in ['1/1']:
        return 'Homozygous Variant'
    else:
        return 'Other'

def create_comprehensive_plots(df, title):
    """ì¢…í•©ì ì¸ ì‹œê°í™” ìƒì„±"""
    
    fig, axes = plt.subplots(3, 2, figsize=(16, 18))
    fig.suptitle(f'{title} - Comprehensive Analysis', fontsize=16, fontweight='bold')
    
    # 1. ë³€ì´ ìœ í˜•ë³„ ë¶„í¬
    type_counts = df['type'].value_counts()
    axes[0, 0].pie(type_counts.values, labels=type_counts.index, autopct='%1.1f%%', 
                   colors=['#3498db', '#e74c3c', '#f39c12', '#9b59b6'])
    axes[0, 0].set_title('ë³€ì´ ìœ í˜•ë³„ ë¶„í¬')
    
    # 2. Transition/Transversion ë¹„ìœ¨
    snp_df = df[df['type'] == 'SNP']
    if not snp_df.empty:
        ti_tv = snp_df['transition'].value_counts()
        axes[0, 1].bar(ti_tv.index, ti_tv.values, color=['#2ecc71', '#e67e22'])
        axes[0, 1].set_title(f'Ti/Tv ë¹„ìœ¨: {ti_tv["Transition"]/ti_tv["Transversion"]:.2f}')
        axes[0, 1].set_ylabel('SNP ê°œìˆ˜')
    
    # 3. ì—¼ìƒ‰ì²´ë³„ ë³€ì´ ë°€ë„
    chrom_counts = df['chrom'].value_counts().head(10)
    axes[1, 0].bar(range(len(chrom_counts)), chrom_counts.values)
    axes[1, 0].set_xticks(range(len(chrom_counts)))
    axes[1, 0].set_xticklabels(chrom_counts.index, rotation=45)
    axes[1, 0].set_title('ì—¼ìƒ‰ì²´ë³„ ë³€ì´ ê°œìˆ˜ (ìƒìœ„ 10ê°œ)')
    axes[1, 0].set_ylabel('ë³€ì´ ê°œìˆ˜')
    
    # 4. í’ˆì§ˆ ì ìˆ˜ ë¶„í¬
    quality_data = df[df['qual'] > 0]['qual']
    axes[1, 1].hist(quality_data, bins=50, alpha=0.7, color='#3498db')
    axes[1, 1].axvline(x=30, color='red', linestyle='--', label='Q30 ì„ê³„ê°’')
    axes[1, 1].set_title('ë³€ì´ í’ˆì§ˆ ì ìˆ˜ ë¶„í¬')
    axes[1, 1].set_xlabel('QUAL Score')
    axes[1, 1].set_ylabel('ë¹ˆë„')
    axes[1, 1].legend()
    
    # 5. ê¹Šì´ ë¶„í¬
    depth_data = df[df['depth'] > 0]['depth']
    axes[2, 0].hist(depth_data, bins=50, alpha=0.7, color='#e74c3c')
    axes[2, 0].axvline(x=depth_data.mean(), color='green', linestyle='--', 
                       label=f'í‰ê· : {depth_data.mean():.1f}')
    axes[2, 0].set_title('ë³€ì´ ê¹Šì´ ë¶„í¬')
    axes[2, 0].set_xlabel('Read Depth')
    axes[2, 0].set_ylabel('ë¹ˆë„')
    axes[2, 0].legend()
    
    # 6. ìœ ì „ìí˜• ë¶„í¬
    gt_counts = df['genotype'].value_counts()
    axes[2, 1].bar(gt_counts.index, gt_counts.values, 
                   color=['#9b59b6', '#f39c12', '#2ecc71', '#95a5a6'])
    axes[2, 1].set_title('ìœ ì „ìí˜• ë¶„í¬')
    axes[2, 1].set_ylabel('ë³€ì´ ê°œìˆ˜')
    axes[2, 1].tick_params(axis='x', rotation=45)
    
    plt.tight_layout()
    plt.savefig(f'{title.lower().replace(" ", "_")}_analysis.png', 
                dpi=300, bbox_inches='tight')
    plt.show()
    
    return df

def generate_summary_statistics(df):
    """ìš”ì•½ í†µê³„ ìƒì„±"""
    
    print(f"\nğŸ“Š ìš”ì•½ í†µê³„:")
    print(f"ì´ ë³€ì´ ìˆ˜: {len(df):,}")
    print(f"SNP: {len(df[df['type'] == 'SNP']):,}")
    print(f"Insertion: {len(df[df['type'] == 'Insertion']):,}")
    print(f"Deletion: {len(df[df['type'] == 'Deletion']):,}")
    
    if len(df[df['type'] == 'SNP']) > 0:
        snp_df = df[df['type'] == 'SNP']
        ti_count = len(snp_df[snp_df['transition'] == 'Transition'])
        tv_count = len(snp_df[snp_df['transition'] == 'Transversion'])
        print(f"Ti/Tv ë¹„ìœ¨: {ti_count/tv_count:.2f}")
    
    print(f"í‰ê·  í’ˆì§ˆ ì ìˆ˜: {df[df['qual'] > 0]['qual'].mean():.2f}")
    print(f"í‰ê·  ê¹Šì´: {df[df['depth'] > 0]['depth'].mean():.1f}")
    
    # ìœ ì „ìí˜• ë¶„í¬
    gt_dist = df['genotype'].value_counts()
    total = len(df)
    print(f"\nğŸ§¬ ìœ ì „ìí˜• ë¶„í¬:")
    for gt, count in gt_dist.items():
        print(f"{gt}: {count:,} ({count/total*100:.1f}%)")

# ë¶„ì„ ì‹¤í–‰
filtered_gatk_file = '/home/ubuntu/edu/soybean_data/variant_calling/soybean_gatk_filtered.vcf.gz'
filtered_bcftools_file = '/home/ubuntu/edu/soybean_data/variant_calling/soybean_bcftools_filtered.vcf.gz'

# GATK í•„í„°ë§ ê²°ê³¼ ë¶„ì„
gatk_df = comprehensive_variant_analysis(filtered_gatk_file, "GATK Filtered Results")
gatk_stats = create_comprehensive_plots(gatk_df, "GATK Filtered")
generate_summary_statistics(gatk_df)

print("\n" + "="*80 + "\n")

# bcftools í•„í„°ë§ ê²°ê³¼ ë¶„ì„
bcftools_df = comprehensive_variant_analysis(filtered_bcftools_file, "bcftools Filtered Results")
bcftools_stats = create_comprehensive_plots(bcftools_df, "bcftools Filtered")
generate_summary_statistics(bcftools_df)
</div>
            </div>
        </div>

        <div class="result-box">
            <h4><i class="fas fa-chart-bar"></i> ì˜ˆìƒ ë¶„ì„ ê²°ê³¼</h4>
            <div class="terminal-output">
ğŸ”¬ GATK Filtered Results
============================================================
ğŸ“Š ìš”ì•½ í†µê³„:
ì´ ë³€ì´ ìˆ˜: 12,456
SNP: 10,234
Insertion: 1,111
Deletion: 1,111
Ti/Tv ë¹„ìœ¨: 2.15
í‰ê·  í’ˆì§ˆ ì ìˆ˜: 52.3
í‰ê·  ê¹Šì´: 31.2

ğŸ§¬ ìœ ì „ìí˜• ë¶„í¬:
Heterozygous: 7,890 (63.3%)
Homozygous Variant: 3,456 (27.8%)
Homozygous Reference: 1,110 (8.9%)

ğŸ”¬ bcftools Filtered Results
============================================================
ğŸ“Š ìš”ì•½ í†µê³„:
ì´ ë³€ì´ ìˆ˜: 15,678
SNP: 12,890
Insertion: 1,394
Deletion: 1,394
Ti/Tv ë¹„ìœ¨: 2.08
í‰ê·  í’ˆì§ˆ ì ìˆ˜: 41.7
í‰ê·  ê¹Šì´: 28.9
            </div>
        </div>

        <h2>ğŸ§¬ 3ë‹¨ê³„: ê¸°ëŠ¥ì  ë³€ì´ ë¶„ì„</h2>
        <div class="practical-box">
            <h3><i class="fas fa-dna"></i> ìœ ì „ì ì˜ì—­ë³„ ë³€ì´ ì˜í–¥ í‰ê°€</h3>
            
            <div class="code-block-container">
                <div class="code-block bash">
# SnpEff ì£¼ì„ ê²°ê³¼ì—ì„œ ê¸°ëŠ¥ì  ì˜í–¥ ë¶„ì„
echo "=== ê¸°ëŠ¥ì  ì˜í–¥ë³„ ë³€ì´ ë¶„ë¥˜ ==="

# ë†’ì€ ì˜í–¥ ë³€ì´ (HIGH impact)
bcftools query -i 'ANN~"HIGH"' \
    -f '%CHROM\t%POS\t%REF\t%ALT\t%ANN\n' \
    soybean_annotated.vcf | head -10

# ì¤‘ê°„ ì˜í–¥ ë³€ì´ (MODERATE impact)
bcftools query -i 'ANN~"MODERATE"' \
    -f '%CHROM\t%POS\t%REF\t%ALT\t%ANN\n' \
    soybean_annotated.vcf | head -10

# ë³€ì´ ì˜í–¥ë³„ ê°œìˆ˜ ì§‘ê³„
echo "=== ì˜í–¥ë³„ ë³€ì´ ê°œìˆ˜ ==="
bcftools query -f '%ANN\n' soybean_annotated.vcf | \
    grep -o 'HIGH\|MODERATE\|LOW\|MODIFIER' | \
    sort | uniq -c
</div>
            </div>
        </div>

        <div class="biological-insight">
            <h4><i class="fas fa-microscope"></i> ìƒë¬¼í•™ì  ì˜ë¯¸ í•´ì„</h4>
            <div class="comparison-table">
                <div class="comparison-item" style="border-left-color: #dc3545;">
                    <h4>HIGH Impact ë³€ì´</h4>
                    <ul>
                        <li><strong>ë‹¨ë°±ì§ˆ ê¸°ëŠ¥ ì†ì‹¤:</strong> ì¡°ê¸° ì¢…ë£Œ, í”„ë ˆì„ì‹œí”„íŠ¸</li>
                        <li><strong>ìƒë¬¼í•™ì  ì¤‘ìš”ì„±:</strong> í‘œí˜„í˜• ë³€í™” ê°€ëŠ¥ì„± ë†’ìŒ</li>
                        <li><strong>ì‹ë¬¼ ìœ¡ì¢…:</strong> ì¤‘ìš” í˜•ì§ˆ ê´€ë ¨ í›„ë³´</li>
                        <li><strong>ìš°ì„ ìˆœìœ„:</strong> ìµœìš°ì„  ê²€ì¦ ëŒ€ìƒ</li>
                    </ul>
                </div>
                
                <div class="comparison-item" style="border-left-color: #f39c12;">
                    <h4>MODERATE Impact ë³€ì´</h4>
                    <ul>
                        <li><strong>ì•„ë¯¸ë…¸ì‚° ë³€í™”:</strong> ë‹¨ë°±ì§ˆ ê¸°ëŠ¥ ë³€í™”</li>
                        <li><strong>ìƒë¬¼í•™ì  ì¤‘ìš”ì„±:</strong> ì¡°ê±´ë¶€ ì˜í–¥ ê°€ëŠ¥</li>
                        <li><strong>ì‹ë¬¼ ìœ¡ì¢…:</strong> ì–‘ì  í˜•ì§ˆ ê´€ë ¨ í›„ë³´</li>
                        <li><strong>ìš°ì„ ìˆœìœ„:</strong> 2ì°¨ ê²€ì¦ ëŒ€ìƒ</li>
                    </ul>
                </div>
            </div>
        </div>

        <h2>ğŸ” 4ë‹¨ê³„: ì£¼ìš” ë³€ì´ ì‹ë³„</h2>
        <div class="practical-box">
            <h3><i class="fas fa-search-plus"></i> ìƒë¬¼í•™ì ìœ¼ë¡œ ì¤‘ìš”í•œ ë³€ì´ ì„ ë³„</h3>
            
            <div class="code-block-container">
                <div class="code-block python">
def identify_important_variants(vcf_file, annotation_file=None):
    """ìƒë¬¼í•™ì ìœ¼ë¡œ ì¤‘ìš”í•œ ë³€ì´ë¥¼ ì‹ë³„í•©ë‹ˆë‹¤."""
    
    print("ğŸ¯ ì¤‘ìš” ë³€ì´ ì‹ë³„ ë¶„ì„")
    print("=" * 50)
    
    # ê³ í’ˆì§ˆ ë³€ì´ ì„ ë³„ ê¸°ì¤€
    important_variants = []
    
    if vcf_file.endswith('.gz'):
        file_opener = gzip.open
        mode = 'rt'
    else:
        file_opener = open
        mode = 'r'
    
    with file_opener(vcf_file, mode) as f:
        for line in f:
            if line.startswith('#'):
                continue
                
            fields = line.strip().split('\t')
            if len(fields) < 10:
                continue
                
            chrom = fields[0]
            pos = int(fields[1])
            ref = fields[3]
            alt = fields[4]
            qual = float(fields[5]) if fields[5] != '.' else 0
            info = fields[7]
            
            # ì¤‘ìš” ë³€ì´ ê¸°ì¤€
            criteria = {
                'high_quality': qual >= 50,
                'good_depth': 15 <= extract_dp_from_info(info) <= 60,
                'heterozygous': '0/1' in fields[9],
                'novel': True  # ì‹¤ì œë¡œëŠ” dbSNPì™€ ë¹„êµ
            }
            
            # ëª¨ë“  ê¸°ì¤€ì„ ë§Œì¡±í•˜ëŠ” ë³€ì´
            if all(criteria.values()):
                important_variants.append({
                    'chrom': chrom,
                    'pos': pos,
                    'ref': ref,
                    'alt': alt,
                    'qual': qual,
                    'info': info
                })
    
    print(f"ğŸŒŸ ì¤‘ìš” ë³€ì´ í›„ë³´: {len(important_variants):,}ê°œ")
    
    # ìƒìœ„ 10ê°œ ë³€ì´ ì¶œë ¥
    sorted_variants = sorted(important_variants, 
                           key=lambda x: x['qual'], reverse=True)
    
    print(f"\nğŸ† ìƒìœ„ 10ê°œ ê³ í’ˆì§ˆ ë³€ì´:")
    print("CHROM\tPOS\tREF\tALT\tQUAL")
    print("-" * 40)
    for var in sorted_variants[:10]:
        print(f"{var['chrom']}\t{var['pos']}\t{var['ref']}\t{var['alt']}\t{var['qual']:.1f}")
    
    return important_variants

def create_variant_summary_report(gatk_df, bcftools_df):
    """ìµœì¢… ìš”ì•½ ë³´ê³ ì„œ ìƒì„±"""
    
    print("\n" + "="*80)
    print("ğŸ“‹ WGS ë¶„ì„ ìµœì¢… ìš”ì•½ ë³´ê³ ì„œ")
    print("="*80)
    
    print(f"\nğŸ”¬ ë¶„ì„ ëŒ€ìƒ: ì½©(Glycine max) ê²Œë†ˆ")
    print(f"ğŸ“… ë¶„ì„ ì¼ì: {pd.Timestamp.now().strftime('%Y-%m-%d')}")
    
    print(f"\nğŸ“Š ë³€ì´ í˜¸ì¶œ ê²°ê³¼ ë¹„êµ:")
    print(f"{'ë°©ë²•':<15} {'ì´ ë³€ì´':<10} {'SNP':<10} {'INDEL':<10} {'Ti/Tv':<8}")
    print("-" * 55)
    
    gatk_snp = len(gatk_df[gatk_df['type'] == 'SNP'])
    gatk_indel = len(gatk_df[gatk_df['type'] != 'SNP'])
    gatk_ti = len(gatk_df[(gatk_df['type'] == 'SNP') & (gatk_df['transition'] == 'Transition')])
    gatk_tv = len(gatk_df[(gatk_df['type'] == 'SNP') & (gatk_df['transition'] == 'Transversion')])
    gatk_ti_tv = gatk_ti / gatk_tv if gatk_tv > 0 else 0
    
    bcf_snp = len(bcftools_df[bcftools_df['type'] == 'SNP'])
    bcf_indel = len(bcftools_df[bcftools_df['type'] != 'SNP'])
    bcf_ti = len(bcftools_df[(bcftools_df['type'] == 'SNP') & (bcftools_df['transition'] == 'Transition')])
    bcf_tv = len(bcftools_df[(bcftools_df['type'] == 'SNP') & (bcftools_df['transition'] == 'Transversion')])
    bcf_ti_tv = bcf_ti / bcf_tv if bcf_tv > 0 else 0
    
    print(f"{'GATK':<15} {len(gatk_df):<10,} {gatk_snp:<10,} {gatk_indel:<10,} {gatk_ti_tv:<8.2f}")
    print(f"{'bcftools':<15} {len(bcftools_df):<10,} {bcf_snp:<10,} {bcf_indel:<10,} {bcf_ti_tv:<8.2f}")
    
    print(f"\nğŸ¯ ì£¼ìš” ë°œê²¬:")
    print(f"â€¢ SNP ë°€ë„: ~{gatk_snp/1000:.1f} SNPs/kb (GATK ê¸°ì¤€)")
    print(f"â€¢ INDEL ë¹„ìœ¨: {gatk_indel/(gatk_snp+gatk_indel)*100:.1f}%")
    print(f"â€¢ Ti/Tv ë¹„ìœ¨: {gatk_ti_tv:.2f} (ì •ìƒ ë²”ìœ„: 2.0-2.5)")
    print(f"â€¢ ì´í˜•ì ‘í•©ë„: {len(gatk_df[gatk_df['genotype'] == 'Heterozygous'])/len(gatk_df)*100:.1f}%")
    
    print(f"\nâœ… í’ˆì§ˆ í‰ê°€:")
    high_qual_gatk = len(gatk_df[gatk_df['qual'] >= 30])
    print(f"â€¢ ê³ í’ˆì§ˆ ë³€ì´ (Qâ‰¥30): {high_qual_gatk:,} ({high_qual_gatk/len(gatk_df)*100:.1f}%)")
    print(f"â€¢ í‰ê·  ê¹Šì´: {gatk_df[gatk_df['depth'] > 0]['depth'].mean():.1f}x")
    print(f"â€¢ í’ˆì§ˆ ê´€ë¦¬: í†µê³¼")

# ë¶„ì„ ì‹¤í–‰
important_gatk = identify_important_variants(filtered_gatk_file)
final_report = create_variant_summary_report(gatk_df, bcftools_df)
</div>
            </div>
        </div>

        <h2>ğŸ“‘ 5ë‹¨ê³„: ê²°ê³¼ ìš”ì•½</h2>
        <div class="summary-box">
            <h3><i class="fas fa-clipboard-check"></i> WGS ë¶„ì„ ì¢…í•© ê²°ê³¼</h3>
            
            <div class="comparison-table">
                <div class="comparison-item" style="border-left-color: #28a745;">
                    <h4><i class="fas fa-check-circle"></i> ì„±ê³µì  ì™„ë£Œ í•­ëª©</h4>
                    <ul>
                        <li>âœ… ì›ì‹œ ë°ì´í„° í’ˆì§ˆ í‰ê°€ ì™„ë£Œ</li>
                        <li>âœ… ì–´ëŒ‘í„° ì œê±° ë° í’ˆì§ˆ í•„í„°ë§ ì™„ë£Œ</li>
                        <li>âœ… ì°¸ì¡° ê²Œë†ˆ ì •ë ¬ (90%+ ë§¤í•‘ë¥ )</li>
                        <li>âœ… ë³€ì´ í˜¸ì¶œ (GATK & bcftools)</li>
                        <li>âœ… ë³€ì´ í•„í„°ë§ ë° ì£¼ì„</li>
                        <li>âœ… ìƒë¬¼í•™ì  í•´ì„ ì™„ë£Œ</li>
                    </ul>
                </div>
                
                <div class="comparison-item" style="border-left-color: #3498db;">
                    <h4><i class="fas fa-chart-line"></i> ì£¼ìš” í†µê³„</h4>
                    <ul>
                        <li><strong>ì´ ë³€ì´:</strong> ~12,000-16,000ê°œ</li>
                        <li><strong>SNP ë¹„ìœ¨:</strong> 82-85%</li>
                        <li><strong>Ti/Tv ë¹„ìœ¨:</strong> 2.08-2.15</li>
                        <li><strong>ê³ í’ˆì§ˆ ë³€ì´:</strong> 80%+</li>
                        <li><strong>ì´í˜•ì ‘í•©ë„:</strong> 60-65%</li>
                        <li><strong>ê¸°ëŠ¥ì  ë³€ì´:</strong> 1-3% (HIGH+MODERATE)</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="exercise-box">
            <h3><i class="fas fa-tasks"></i> ìµœì¢… ì‹¤ìŠµ ê³¼ì œ</h3>
            <ol>
                <li>ë‘ ë³€ì´ í˜¸ì¶œ ë°©ë²•ì˜ ì¥ë‹¨ì ì„ ë¹„êµ ë¶„ì„í•˜ì„¸ìš”</li>
                <li>Ti/Tv ë¹„ìœ¨ì´ ì •ìƒ ë²”ìœ„ì¸ì§€ í‰ê°€í•˜ê³  ì˜ë¯¸ë¥¼ ì„¤ëª…í•˜ì„¸ìš”</li>
                <li>HIGH impact ë³€ì´ë“¤ì˜ ìƒë¬¼í•™ì  ì˜ë¯¸ë¥¼ í•´ì„í•˜ì„¸ìš”</li>
                <li>ì´í˜•ì ‘í•© ë³€ì´ì™€ ë™í˜•ì ‘í•© ë³€ì´ì˜ ë¶„í¬ ì°¨ì´ë¥¼ ë¶„ì„í•˜ì„¸ìš”</li>
                <li>ì—¼ìƒ‰ì²´ë³„ ë³€ì´ ë°€ë„ ì°¨ì´ì˜ ì›ì¸ì„ ì¶”ë¡ í•˜ì„¸ìš”</li>
                <li>ì‹ë¬¼ ìœ¡ì¢… ê´€ì ì—ì„œ ì¤‘ìš”í•œ ë³€ì´ë¥¼ ì„ ë³„í•˜ì„¸ìš”</li>
                <li>ì „ì²´ ë¶„ì„ ê³¼ì •ì˜ í•œê³„ì ê³¼ ê°œì„ ì ì„ ì œì‹œí•˜ì„¸ìš”</li>
            </ol>
        </div>

        <div class="visualization-box">
            <h4><i class="fas fa-eye"></i> IGVë¥¼ ì´ìš©í•œ ì‹œê°ì  ê²€ì¦</h4>
            <p>ì£¼ìš” ë³€ì´ë“¤ì€ IGV(Integrative Genomics Viewer)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹œê°ì ìœ¼ë¡œ ê²€ì¦í•˜ëŠ” ê²ƒì´ ê¶Œì¥ë©ë‹ˆë‹¤. BAM íŒŒì¼ê³¼ VCF íŒŒì¼ì„ IGVì— ë¡œë“œí•˜ì—¬ ë³€ì´ì˜ ì‹ ë¢°ì„±ì„ ìœ¡ì•ˆìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>

        <div class="warning-box">
            <h4><i class="fas fa-exclamation-triangle"></i> ê²°ê³¼ í•´ì„ ì‹œ ì£¼ì˜ì‚¬í•­</h4>
            <ul>
                <li><strong>í†µê³„ì  ê²€ì¦:</strong> ì¶©ë¶„í•œ ìƒ˜í”Œ ìˆ˜ ì—†ì´ëŠ” ì¼ë°˜í™” ì–´ë ¤ì›€</li>
                <li><strong>ì°¸ì¡° ê²Œë†ˆ í•œê³„:</strong> ì°¸ì¡° ê²Œë†ˆì˜ í’ˆì§ˆì´ ê²°ê³¼ì— ì˜í–¥</li>
                <li><strong>ê¸°ëŠ¥ ì˜ˆì¸¡:</strong> ì „ì‚° ì˜ˆì¸¡ì€ ì‹¤í—˜ì  ê²€ì¦ í•„ìš”</li>
                <li><strong>ì§‘ë‹¨ íŠ¹ì„±:</strong> ë¶„ì„ ìƒ˜í”Œì˜ ì§‘ë‹¨ íŠ¹ì„± ê³ ë ¤ í•„ìš”</li>
                <li><strong>ê¸°ìˆ ì  í¸í–¥:</strong> ì‹œí€€ì‹± ë° ë¶„ì„ ë°©ë²•ì˜ í¸í–¥ ì¸ì§€</li>
            </ul>
        </div>

        <div class="performance-tip">
            <h4><i class="fas fa-lightbulb"></i> ì¶”ê°€ ë¶„ì„ ì œì•ˆ</h4>
            <ul>
                <li><strong>êµ¬ì¡°ì  ë³€ì´:</strong> CNV, ì „ìœ„ ë“± ëŒ€ê·œëª¨ ë³€ì´ ë¶„ì„</li>
                <li><strong>ì§‘ë‹¨ ë¶„ì„:</strong> ë‹¤ì¤‘ ìƒ˜í”Œ ë¹„êµë¥¼ í†µí•œ ì§‘ë‹¨ ìœ ì „í•™</li>
                <li><strong>ê¸°ëŠ¥ ê²€ì¦:</strong> ì£¼ìš” ë³€ì´ì˜ ì‹¤í—˜ì  ê²€ì¦</li>
                <li><strong>í‘œí˜„í˜• ì—°ê´€:</strong> í‘œí˜„í˜•ê³¼ ìœ ì „ìí˜• ì—°ê´€ ë¶„ì„</li>
                <li><strong>ì§„í™” ë¶„ì„:</strong> ì¢…ê°„/í’ˆì¢…ê°„ ë¹„êµ ì§„í™” ë¶„ì„</li>
            </ul>
        </div>
    </div>
</div>

<div class="navigation">
    <button class="nav-btn" onclick="window.location.href='slide07.html'">â—€ ì´ì „</button>
    <button class="nav-btn" onclick="window.location.href='index.html'">ğŸ  ëª©ì°¨</button>
    <button class="fullscreen-btn" onclick="toggleFullscreen()">â›¶</button>
    <button class="jump-btn" onclick="jumpToSlide()">ì´ë™</button>
</div>

<div class="slide-number">ìŠ¬ë¼ì´ë“œ 8</div>

<script>
    function prevSlide() {
        window.location.href = "slide07.html";
    }
    
    function nextSlide() {
        window.location.href = "index.html";
    }
    
    function jumpToIndex() {
        window.location.href = "index.html";
    }
    
    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
    }
    
    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowRight' || e.key === ' ') {
            nextSlide();
        } else if (e.key === 'ArrowLeft') {
            prevSlide();
        } else if (e.key === 'Home') {
            jumpToIndex();
        } else if (e.key === 'F11') {
            e.preventDefault();
            toggleFullscreen();
        }
    });
    
    // Syntax highlighting function
    function highlightCode() {
        const codeBlocks = document.querySelectorAll('.code-block');
        
        codeBlocks.forEach(block => {
            const code = block.textContent;
            const language = block.classList.contains('python') ? 'python' : 
                           block.classList.contains('bash') ? 'bash' : 'python'; // default to python
            
            const highlightedCode = highlightSyntax(code, language);
            block.innerHTML = highlightedCode;
            
            // Add copy button
            addCopyButton(block, code);
        });
    }
    
    // Add copy button to code block
    function addCopyButton(codeBlock, originalCode) {
        // Check if copy button already exists
        const container = codeBlock.parentElement;
        if (container && container.querySelector('.copy-button')) {
            return; // Copy button already exists
        }
        
        const copyButton = document.createElement('button');
        copyButton.className = 'copy-button';
        copyButton.textContent = 'Copy';
        copyButton.title = 'Copy code to clipboard';
        
        copyButton.addEventListener('click', function() {
            copyToClipboard(originalCode, copyButton);
        });
        
        // Append to container if it exists, otherwise to code block
        if (container && container.classList.contains('code-block-container')) {
            container.appendChild(copyButton);
        } else {
            codeBlock.style.position = 'relative'; // Ensure positioning context
            codeBlock.appendChild(copyButton);
        }
    }
    
    // Copy text to clipboard
    function copyToClipboard(text, button) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            // Modern approach
            navigator.clipboard.writeText(text).then(function() {
                showCopySuccess(button);
            }).catch(function() {
                fallbackCopyToClipboard(text, button);
            });
        } else {
            // Fallback for older browsers
            fallbackCopyToClipboard(text, button);
        }
    }
    
    // Fallback copy method
    function fallbackCopyToClipboard(text, button) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            document.execCommand('copy');
            showCopySuccess(button);
        } catch (err) {
            console.error('Copy failed:', err);
        }
        
        document.body.removeChild(textArea);
    }
    
    // Show copy success feedback
    function showCopySuccess(button) {
        const originalText = button.textContent;
        button.textContent = 'Copied!';
        button.classList.add('copied');
        
        setTimeout(function() {
            button.textContent = originalText;
            button.classList.remove('copied');
        }, 2000);
    }
    
    function highlightSyntax(code, language) {
        if (language === 'python') {
            return highlightPython(code);
        } else if (language === 'bash') {
            return highlightBash(code);
        }
        return code;
    }
    
    function highlightPython(code) {
        let highlighted = code;
        
        // 1. Highlight strings first
        highlighted = highlighted.replace(/"[^"]*"/g, '<span class="string">$&</span>');
        highlighted = highlighted.replace(/'[^']*'/g, '<span class="string">$&</span>');
        
        // 2. Highlight comments
        highlighted = highlighted.replace(/#.*$/gm, '<span class="comment">$&</span>');
        
        // 3. Highlight keywords
        const keywords = ['import', 'from', 'def', 'if', 'else', 'elif', 'for', 'while', 'try', 'except', 'with', 'as', 'return', 'and', 'or', 'not', 'in', 'is', 'True', 'False', 'None'];
        keywords.forEach(keyword => {
            const regex = new RegExp(`\\b${keyword}\\b`, 'g');
            highlighted = highlighted.replace(regex, `<span class="keyword">${keyword}</span>`);
        });
        
        // 4. Highlight built-in functions
        const builtins = ['print', 'len', 'open', 'range', 'enumerate', 'gzip', 'os', 'plt', 'np', 'Counter'];
        builtins.forEach(builtin => {
            const regex = new RegExp(`\\b${builtin}\\b`, 'g');
            highlighted = highlighted.replace(regex, `<span class="builtin">${builtin}</span>`);
        });
        
        // 5. Highlight function definitions
        highlighted = highlighted.replace(/\b(def\s+)(\w+)/g, '$1<span class="function">$2</span>');
        
        // 6. Highlight numbers
        highlighted = highlighted.replace(/\b\d+\b/g, '<span class="number">$&</span>');
        
        return highlighted;
    }
    
    function highlightBash(code) {
        const keywords = ['if', 'then', 'else', 'elif', 'fi', 'for', 'while', 'do', 'done', 'case', 'esac', 'function', 'return', 'local', 'export', 'echo', 'cd', 'ls', 'mkdir', 'cp', 'mv', 'rm', 'chmod', 'chown', 'grep', 'sed', 'awk', 'sort', 'uniq', 'wc', 'cat', 'head', 'tail'];
        
        // Split into lines to process line by line (avoids conflicts)
        const lines = code.split('\n');
        const highlightedLines = [];
        
        for (let line of lines) {
            let highlighted = line;
            
            // Skip if line is empty
            if (!highlighted.trim()) {
                highlightedLines.push(highlighted);
                continue;
            }
            
            // 1. Highlight shebang
            if (highlighted.match(/^#!/)) {
                highlighted = highlighted.replace(/^(#!.*)$/, '<span class="shebang">$1</span>');
                highlightedLines.push(highlighted);
                continue;
            }
            
            // 2. Highlight full-line comments
            if (highlighted.trim().startsWith('#')) {
                highlighted = highlighted.replace(/^(\s*)(#.*)$/, '$1<span class="comment">$2</span>');
                highlightedLines.push(highlighted);
                continue;
            }
            
            // 3. Highlight strings
            highlighted = highlighted.replace(/("[^"]*")/g, '<span class="string">$1</span>');
            highlighted = highlighted.replace(/('[^']*')/g, '<span class="string">$1</span>');
            
            // 4. Highlight inline comments (after code)
            highlighted = highlighted.replace(/(\s+)(#.*)$/, '$1<span class="comment">$2</span>');
            
            // 5. Highlight variables
            highlighted = highlighted.replace(/(\$\w+)/g, '<span class="variable">$1</span>');
            
            // 6. Highlight keywords
            keywords.forEach(keyword => {
                const regex = new RegExp(`\\b${keyword}\\b`, 'g');
                highlighted = highlighted.replace(regex, `<span class="keyword">${keyword}</span>`);
            });
            
            highlightedLines.push(highlighted);
        }
        
        return highlightedLines.join('\n');
    }
    
    // Apply syntax highlighting when page loads
    document.addEventListener('DOMContentLoaded', highlightCode);
</script>

</body>
</html>